<!DOCTYPE html>
<html>
<head>
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <style>
        .remote video {
            width: 100% !important;
        }
    </style>

    <script src="https://cloud.apizee.com/libs/jquery-1.9.0.min.js"></script>
    <script src="cordova.js"></script>
    <script src="https://cloud.apizee.com/apiRTC/apiRTC-latest.min.js"></script>
</head>

<body>

<div class="container-fluid" style="margin-top: 35px;margin-left: 5px; margin-right: 5px">
    <div class="row">
        <input type="number" id="number" value="" class="form-control" placeholder="Enter Destination ID"/>
    </div>
    <div class="row" style="margin-top: 5px">
        <input id="call" type="button" value="Call" class="btn btn-success" style="width: 100%; border-radius: 0;" />
        <input id="hangup" type="button" value="Hangup" class="btn btn-danger" style="width: 100%; border-radius: 0;display: none"/>
    </div>
    <div class="row" id="localNumber" style="text-align: center; font-size: 18px; margin-top: 5px">
    </div>
    <div class="row" style="text-align: center;">
        <span id="status" style="text-align: center">Registration Ongoing...</span>
    </div>
    <div class="row" style="margin-top: 20px">
        <div class="remote" id="myRemoteVideo" style="width:100%;"></div>
    </div>
    <div class="row">
        <video width="30%" height="30%" id="myMiniVideo" autoplay style="display: none"></video>
    </div>
</div>



<script>
            'use strict';
			var arr=[ ]
			
			for(var i=0; i<10; i++) {
				arr.push(null)
			}			
			
			for(var i=0; i<10; i++) {
				arr.push(i.toString())
			}

			for(var i=97; i<123; i++) {
				arr.push(String.fromCharCode(i))
			}
			arr.push('-')
			arr.push('_')
			arr.push('.')
			arr.push('$')
			arr.push('*')
			arr.push('@')
			arr.push('!')
			arr.push('#')
			arr.push('%')
			arr.push('+')
			arr.push('&')
			arr.push('=')
			arr.push('?')

            var session = null,
                webRTCClient = null,
                connectedUsersList = [],
			//Accept-Refuse
                incomingCallId = 0;
			var num
			var login
			var to_call
			
			var to = qs('to')
			if (!to) to = $('#patient_login').val()

		
			var login = qs('login')
			if (login == '') login = getCookie('login')
				else login = qs('login')

			setCookie('login', login)
			if (to) {
				document.getElementById('patient_login').value=to
				document.getElementById('encodedLogin').value=encode(to)
				to_call=encode(to)
			}
			
			function setStatus(tx) {
				$('#status').html(tx)
			}
			var cssText
			
    function refreshVideoView() {
        if ((typeof device !== "undefined") && device.platform == 'iOS'){
            console.log("REFRESH");
            cordova.plugins.iosrtc.refreshVideos();
        }
    }

    function incomingCallHandler(e) {
        $("#call").hide();
        $("#number").hide();
        $("#hangup").show();
        $('#status').hide();
        setTimeout(refreshVideoView,2000);
    }

    function hangupHandler(e) {
        $("#call").show();
        $("#number").show();
        $("#hangup").hide();
        $('#status').html(e.detail.reason);
        $('#status').show();
    }

    function userMediaErrorHandler(e) {
        $("#call").show();
        $("#number").show();
        $("#hangup").hide();
    }

    function remoteStreamAddedHandler(e) {
        refreshVideoView();
    }

    function sessionReadyHandler(e) {

        apiRTC.addEventListener("incomingCall", incomingCallHandler);
        apiRTC.addEventListener("userMediaError", userMediaErrorHandler);
        apiRTC.addEventListener("remoteStreamAdded", remoteStreamAddedHandler);
        apiRTC.addEventListener("hangup", hangupHandler);

        var webRTCClient = apiCC.session.createWebRTCClient({
            minilocalVideo : "myMiniVideo",
            remoteVideo : "myRemoteVideo"
        });

        $('#localNumber').html("Your local ID :<BR/>"+apiCC.session.apiCCId);
        $('#myMiniVideo').show();
        $('#status').hide();

        $("#call").click(function () {
            $("#call").hide();
            $("#number").hide();
            $("#hangup").show();
            $('#status').hide();

            destNumber = $("#number").val();
            console.log("send REFRESH");
            setTimeout(refreshVideoView,4000);
            webRTCClient.call(destNumber);
        });

        $("#hangup").click(function () {
            $("#call").show();
            $("#number").show();
            $("#hangup").hide();

            webRTCClient.hangUp();
        });
    }

    function onDeviceReady() {

        if ((typeof device !== "undefined") && device.platform == 'iOS'){
            cordova.plugins.iosrtc.registerGlobals();
        }


        if ((typeof device !== "undefined") && device.platform == 'Android'){
            var permissions = cordova.plugins.permissions;
            permissions.hasPermission(permissions.CAMERA, checkVideoPermissionCallback, null);
            permissions.hasPermission(permissions.RECORD_AUDIO, checkAudioPermissionCallback, null);

            function checkVideoPermissionCallback(status) {
                if(!status.hasPermission) {
                    var errorCallback = function() {
                        alert('Camera permission is not turned on');
                    }
                    permissions.requestPermission(
                            permissions.CAMERA,
                            function(status) {
                                if(!status.hasPermission) {
                                    errorCallback();
                                }
                            },
                            errorCallback);
                }
            }

            function checkAudioPermissionCallback(status) {
                if(!status.hasPermission) {
                    var errorCallback = function() {
                        alert('Audio permission is not turned on');
                    }
                    permissions.requestPermission(
                            permissions.RECORD_AUDIO,
                            function(status) {
                                if(!status.hasPermission) {
                                    errorCallback();
                                }
                            },
                            errorCallback);
                }
            }
        }

        apiRTC.init({
            apiCCId : encode(login),
            onReady: sessionReadyHandler,
            apiKey : "werrx"
        });

    }

    var app = document.URL.indexOf( 'https://' ) === -1;
    if ( app ) {
        document.addEventListener("deviceready", onDeviceReady, false);
    } else {
        onDeviceReady();
    }
	}

	function encode(str){
		var nums = '';
		for(var i=0; i<str.length; i++) {
			nums += arr.indexOf(str[i]).toString().trim()
		}
		return nums
	}

	function decode(um){
		var st=um.split('|')
		console.log(um)
		var strOut = '';
		for(var i=0; i<um.length; i+=2){
			console.log(i + ': ' + um.substring(i,i+2)*1)
			var s=(um.substring(i,i+2)*1);
			strOut += arr[s*1]
		}
		return strOut;
	}	

	var wl = window.location.href;
	var mob = (window.location.href.indexOf('file://')>=0);

	function setCookie(cname,cvalue)	{
		if (mob===true) {
			window.localStorage.setItem(cname, cvalue);
		} else {
			var d = new Date(); 
			d.setTime(d.getTime()+(1*24*60*60*1000)); 
			var expires = "expires="+d.toGMTString(); 
			document.cookie = cname + "=" + cvalue + "; " + expires; 
		}
	} 

	function getCookie(cname)	{ 
		if (mob===true) {
			var cvalue = window.localStorage.getItem(cname);
			return cvalue
		} else {
			var name = cname + "="; 
			var ca = document.cookie.split(';'); 
			for(var i=0; i<ca.length; i++) { 
			  var c = ca[i].trim(); 
			  if (c.indexOf(name)==0) return c.substring(name.length,c.length); 
			} 
			return ""; 
		}
	} 

	function delCookie(cname) {
		if (mob===true) {
			window.localStorage.removeItem(cname);
		} else {
			var d = new Date();
			d.setTime(d.getTime());
			var expires = "expires="+d.toGMTString();
			document.cookie = cname + "=" + "" + "; " + expires;
		}
	}
	
</script>
</body>
</html>